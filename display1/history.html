<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>4컷 만화 스타일 갤러리</title>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap");
      @import url("https://fonts.googleapis.com/css2?family=Comic+Neue:wght@700&display=swap");

      body {
        background-color: #f8f4e9;
        /* background-image: url("https://d2w79zoxq32d33.cloudfront.net/html/background.jpg"); */
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
        min-height: 100vh;
        margin: 0;
        font-family: "Noto Sans KR", sans-serif;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 0;
        overflow-x: hidden;
      }

      .comic-title {
        font-family: "Comic Neue", cursive;
        font-size: 2.5rem;
        color: #333;
        text-align: center;
        margin: 15px 0;
        background-color: #fff;
        padding: 10px 30px;
        border-radius: 50px;
        border: 3px solid #000;
        box-shadow: 5px 5px 0 #000;
        transform: rotate(-2deg);
      }

      /* 정보 상단 박스 */
      .info-header {
        max-width: 95vw;
        width: 95%;
        background-color: #fffd9e;
        border: 5px solid #000;
        border-radius: 15px;
        padding: 15px;
        box-shadow: 10px 10px 0 #000;
        margin-bottom: 20px;
        display: flex;
        flex-wrap: wrap;
        justify-content: space-between;
        position: relative;
        z-index: 5;
      }

      .info-header::before {
        content: "오늘의 추천 메뉴!";
        position: absolute;
        top: -15px;
        left: 30px;
        background-color: #ff5252;
        color: white;
        padding: 5px 15px;
        border: 3px solid #000;
        border-radius: 30px;
        font-family: "Comic Neue", cursive;
        font-weight: bold;
        transform: rotate(-5deg);
        box-shadow: 3px 3px 0 #000;
        z-index: 10;
      }

      .today-info,
      .food-info {
        width: 48%;
        background-color: white;
        border: 3px solid #000;
        border-radius: 12px;
        padding: 10px;
        box-shadow: 5px 5px 0 #000;
        margin-bottom: 10px;
      }

      @media (max-width: 768px) {
        .today-info,
        .food-info {
          width: 100%;
        }
      }

      .info-title {
        font-family: "Comic Neue", cursive;
        background-color: #9999ff;
        color: #000;
        padding: 5px 10px;
        border: 2px solid #000;
        border-radius: 20px;
        display: inline-block;
        margin: 0 0 10px 0;
        transform: rotate(-2deg);
        box-shadow: 2px 2px 0 #000;
      }
      .comic-container {
        max-width: 95vw;
        width: 95%;
        background-color: #fff;
        border: 5px solid #000;
        border-radius: 15px;
        padding: 15px;
        box-shadow: 10px 10px 0 #000;
        margin-bottom: 20px;
      }

      .comic-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        grid-template-rows: repeat(2, auto);
        gap: 30px;
        padding: 10px;
        max-width: 100%;
        margin: 0;
      }

      .comic-panel {
        position: relative;
        width: 100%;
        height: 0;
        padding-bottom: 100%;
        background-color: #fff;
        border: 5px solid #000;
        border-radius: 5px;
        overflow: hidden;
        box-shadow: inset 0 0 15px rgba(0, 0, 0, 0.2);
        transition: transform 0.3s ease;
      }

      .comic-panel img,
      .comic-panel video {
        position: absolute;
        width: 100%;
        height: 100%;
        object-fit: cover;
        top: 0;
        left: 0;
      }

      /* 패널 번호 스타일 제거 */

      .panel-caption {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        background-color: rgba(255, 255, 255, 0.8);
        padding: 8px;
        font-family: "Comic Neue", cursive;
        font-weight: bold;
        text-align: center;
        border-top: 3px solid #000;
      }

      /* 말풍선 스타일 */
      .speech-bubble {
        position: absolute;
        background-color: #fff;
        border: 3px solid #000;
        border-radius: 20px;
        padding: 8px 15px;
        font-family: "Comic Neue", cursive;
        font-weight: bold;
        font-size: 1.1rem;
        max-width: 70%;
        text-align: center;
        box-shadow: 3px 3px 0 #000;
        z-index: 5;
      }

      .speech-bubble::after {
        content: "";
        position: absolute;
        border: 15px solid transparent;
        border-top-color: #fff;
        border-bottom: 0;
        bottom: -12px;
        left: 50%;
        margin-left: -15px;
        z-index: 5;
      }

      .speech-bubble::before {
        content: "";
        position: absolute;
        border: 18px solid transparent;
        border-top-color: #000;
        border-bottom: 0;
        bottom: -18px;
        left: 50%;
        margin-left: -18px;
        z-index: 4;
      }

      .panel-1-bubble {
        top: 20px;
        left: 15px;
        background-color: #ffff99;
      }

      .panel-2-bubble {
        top: 20px;
        right: 15px;
        background-color: #ff9999;
      }

      .panel-3-bubble {
        top: 20px;
        left: 15px;
        background-color: #99ff99;
      }

      .panel-4-bubble {
        top: 20px;
        right: 15px;
        background-color: #9999ff;
      }

      /* 효과음 스타일 */
      .sound-effect {
        position: absolute;
        font-family: "Comic Neue", cursive;
        font-weight: bold;
        font-size: 2rem;
        color: #ff5252;
        text-shadow: 2px 2px 0 #000;
        z-index: 5;
        transform: rotate(-10deg);
      }

      .panel-1-effect {
        top: 65%;
        right: 20px;
      }

      .panel-2-effect {
        top: 60%;
        left: 20px;
      }

      .panel-3-effect {
        top: 65%;
        right: 25px;
      }

      .panel-4-effect {
        top: 60%;
        left: 25px;
      }

      .text-content {
        background-color: #fff;
        border: 5px solid #000;
        border-radius: 15px;
        padding: 20px;
        font-family: "Noto Sans KR", sans-serif;
        line-height: 1.6;
        max-width: 95vw;
        width: 95%;
        margin-top: 20px;
        margin-bottom: 20px;
        box-shadow: 10px 10px 0 #000;
        position: relative;
      }

      .text-content::before {
        content: "";
        position: absolute;
        width: 30px;
        height: 30px;
        background-color: #fff;
        border-left: 5px solid #000;
        border-top: 5px solid #000;
        top: -20px;
        left: 50%;
        transform: translateX(-50%) rotate(45deg);
      }

      .text-content h4 {
        margin: 0 0 10px 0;
        color: #333;
        font-size: 1.5rem;
        border-bottom: 3px dashed #ff5252;
        padding-bottom: 5px;
        display: inline-block;
      }

      .text-content ul {
        margin: 0;
        padding-left: 20px;
        list-style-type: none;
      }

      .text-content ul li {
        position: relative;
        padding-left: 25px;
        margin-bottom: 8px;
      }

      .text-content ul li::before {
        content: "✦";
        position: absolute;
        left: 0;
        color: #ff5252;
        font-weight: bold;
      }

      .emotion-highlight {
        display: inline-block;
        background-color: #ffff00;
        padding: 3px 8px;
        border-radius: 10px;
        font-weight: bold;
        transform: rotate(-2deg);
        margin: 0 2px;
        border: 2px solid #000;
        box-shadow: 2px 2px 0 #000;
      }

      .situation-box {
        background-color: #e6f7ff;
        border: 3px solid #000;
        border-radius: 10px;
        padding: 10px 15px;
        margin: 10px 0;
        box-shadow: 5px 5px 0 #000;
      }

      .text-content pre {
        background-color: #fffc9e;
        padding: 15px;
        border-radius: 10px;
        margin: 15px 0;
        border: 3px solid #000;
        font-family: "Noto Sans KR", sans-serif;
        white-space: pre-wrap;
      }

      .thought-bubble {
        position: absolute;
        width: 60px;
        height: 60px;
        background-color: #fff;
        border: 3px solid #000;
        border-radius: 50%;
        top: -70px;
        right: 30px;
        z-index: 5;
      }

      .thought-bubble::before,
      .thought-bubble::after {
        content: "";
        position: absolute;
        background-color: #fff;
        border: 3px solid #000;
        border-radius: 50%;
      }

      .thought-bubble::before {
        width: 30px;
        height: 30px;
        bottom: -15px;
        right: 10px;
      }

      .thought-bubble::after {
        width: 15px;
        height: 15px;
        bottom: -25px;
        right: 0;
      }

      .loading {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 200px;
        width: 100%;
      }

      .loading-spinner {
        border: 8px solid #f3f3f3;
        border-top: 8px solid #ff5252;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .error-message {
        background-color: #ffdddd;
        color: #ff0000;
        padding: 15px;
        border-radius: 10px;
        margin: 20px 0;
        border: 3px solid #ff0000;
        font-weight: bold;
        text-align: center;
      }

      .refresh-button {
        background-color: #ff5252;
        color: white;
        font-family: "Comic Neue", cursive;
        font-weight: bold;
        font-size: 1.2rem;
        padding: 10px 20px;
        border: 3px solid #000;
        border-radius: 10px;
        box-shadow: 5px 5px 0 #000;
        cursor: pointer;
        margin-bottom: 30px;
        transition: transform 0.2s, box-shadow 0.2s;
      }

      .refresh-button:hover {
        transform: translateY(-2px);
        box-shadow: 7px 7px 0 #000;
      }

      .refresh-button:active {
        transform: translateY(2px);
        box-shadow: 3px 3px 0 #000;
      }

      .timer-container {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background-color: rgba(255, 255, 255, 0.9);
        border: 3px solid #000;
        border-radius: 10px;
        padding: 10px;
        font-family: "Comic Neue", cursive;
        font-weight: bold;
        box-shadow: 5px 5px 0 #000;
        z-index: 100;
      }

      .timer-text {
        margin: 0;
        color: #333;
      }

      .timer-progress {
        width: 100%;
        height: 10px;
        background-color: #f3f3f3;
        border-radius: 5px;
        margin-top: 5px;
        overflow: hidden;
      }

      .timer-bar {
        height: 100%;
        background-color: #ff5252;
        border-radius: 5px;
        width: 100%;
        transition: width 1s linear;
      }
    </style>
  </head>
  <body>
    <h1 id="comicTitle" class="comic-title">오늘의 요리 이야기</h1>

    <div class="comic-container">
      <div id="comicGrid" class="comic-grid">
        <div class="loading">
          <div class="loading-spinner"></div>
        </div>
      </div>
    </div>

    <div id="textContent" class="text-content">
      <div class="thought-bubble"></div>
      <div class="loading">
        <div class="loading-spinner"></div>
      </div>
    </div>

    <button class="refresh-button" id="refreshButton">다른 이야기 보기</button>

    <div class="timer-container">
      <p class="timer-text">
        다음 이야기까지: <span id="countdown">20</span>초
      </p>
      <div class="timer-progress">
        <div id="timerBar" class="timer-bar"></div>
      </div>
    </div>

    <script>
      // 설정값
      const LAMBDA_ENDPOINT =
        "https://2hqhh2v9gd.execute-api.ap-northeast-1.amazonaws.com/prd/toons-craft-history";
      const REFRESH_INTERVAL = 20; // 자동 갱신 시간(초)

      // 말풍선 텍스트 설정
      const speechBubbleTexts = [
        "재료 준비 완료!",
        "양념이 핵심이지!",
        "이렇게 끓여야 맛있어~",
        "완성! 맛있게 드세요!",
      ];

      // 효과음 텍스트 설정
      const soundEffectTexts = ["탁! 탁!", "와글와글!", "보글보글~", "짜잔!"];

      // 캡션 텍스트 설정
      const captionTexts = [
        "신선한 재료로 시작해요",
        "정성스럽게 준비합니다",
        "푹 끓여 깊은 맛을 냅니다",
        "완성된 요리를 즐겨보세요",
      ];

      // Lambda 함수에서 데이터 가져오기
      async function fetchDataFromLambda() {
        try {
          const response = await fetch(LAMBDA_ENDPOINT);
          if (!response.ok) {
            throw new Error("API 응답이 올바르지 않습니다.");
          }
          return await response.json();
        } catch (error) {
          console.error("데이터를 가져오는 중 오류가 발생했습니다:", error);
          return null;
        }
      }

      // 감정 표시 형식 지정
      function formatEmotions(emotions) {
        if (!emotions) return "";

        return emotions
          .split(",")
          .map(
            (emotion) =>
              `<span class="emotion-highlight">${emotion.trim()}</span>`
          )
          .join(" ");
      }

      // 데이터를 가져와 화면에 표시하는 함수
      async function renderData() {
        try {
          const data = await fetchDataFromLambda();
          if (!data) {
            throw new Error("데이터를 가져오지 못했습니다.");
          }

          const comicGrid = document.getElementById("comicGrid");
          const textContent = document.getElementById("textContent");
          const comicTitle = document.getElementById("comicTitle");

          // 로딩 표시 제거
          comicGrid.innerHTML = "";

          // 에피소드 정보를 제목에 적용
          comicTitle.textContent = `${data.recommend_id} - 오늘의 요리 이야기`;

          // 미디어 패널 생성
          const mediaList = data.media_list || [];
          mediaList.forEach((mediaUrl, index) => {
            if (index >= 4) return; // 최대 4개 패널만 표시

            const panel = document.createElement("div");
            panel.className = "comic-panel";

            // 미디어 타입에 따라 이미지 또는 비디오 태그 생성
            if (mediaUrl && mediaUrl.endsWith(".mp4")) {
              panel.innerHTML = `
                <video controls loop autoplay muted playsinline>
                  <source src="${mediaUrl}" type="video/mp4">
                  브라우저가 비디오를 지원하지 않습니다.
                </video>
                <div class="speech-bubble panel-${index + 1}-bubble">${
                speechBubbleTexts[index]
              }</div>
                <div class="sound-effect panel-${index + 1}-effect">${
                soundEffectTexts[index]
              }</div>
                <div class="panel-caption">${captionTexts[index]}</div>
              `;
            } else {
              panel.innerHTML = `
                <img src="${mediaUrl}" alt="만화 컷 ${index + 1}">
                <div class="speech-bubble panel-${index + 1}-bubble">${
                speechBubbleTexts[index]
              }</div>
                <div class="sound-effect panel-${index + 1}-effect">${
                soundEffectTexts[index]
              }</div>
                <div class="panel-caption">${captionTexts[index]}</div>
              `;
            }

            comicGrid.appendChild(panel);
          });

          // 추천 정보 표시
          const recommend = data.recommend || {};
          const recommendResult = data.result?.recommendation_result || {};

          // 텍스트 내용 표시
          textContent.innerHTML = `
            <div class="thought-bubble"></div>
            <h4>오늘의 당신은?</h4>
            <ul>
              <li><strong>현재 감정</strong>: ${formatEmotions(
                recommend.user_emotion
              )}</li>
              <li>
                <strong>상황</strong>: 
                <div class="situation-box">
                  ${recommend.user_episode || ""}
                </div>
              </li>
            </ul>
            <h4>추천 음식</h4>
            <pre>${recommendResult.title || `오늘의 추천 메뉴`}</pre>
            <h4>추천 이유</h4>
            <p>${recommendResult.description || ""}</p>
            <ul>
              <li>${recommendResult.reason_1 || ""}</li>
              <li>${recommendResult.reason_2 || ""}</li>
              <li>${recommendResult.reason_3 || ""}</li>
            </ul>
          `;

          // 비디오 자동 재생 설정
          document.querySelectorAll("video").forEach((video) => {
            video.play().catch((error) => {
              console.warn("자동 재생이 제한되었습니다:", error);
            });
          });
        } catch (error) {
          // 오류 처리
          const comicGrid = document.getElementById("comicGrid");
          const textContent = document.getElementById("textContent");

          comicGrid.innerHTML =
            '<div class="error-message">컷을 불러오는 중 오류가 발생했습니다.</div>';
          textContent.innerHTML =
            '<div class="error-message">콘텐츠를 불러오는 중 오류가 발생했습니다.</div>';

          console.error("렌더링 중 오류가 발생했습니다:", error);
        }
      }

      // 새로고침 타이머 설정
      function setupRefreshTimer() {
        let timeLeft = REFRESH_INTERVAL;
        const countdownElement = document.getElementById("countdown");
        const timerBar = document.getElementById("timerBar");

        // 초기 타이머 바 설정
        timerBar.style.width = "100%";

        // 1초마다 타이머 업데이트
        const timer = setInterval(() => {
          timeLeft--;
          countdownElement.textContent = timeLeft;

          // 타이머 바 업데이트
          const percentage = (timeLeft / REFRESH_INTERVAL) * 100;
          timerBar.style.width = percentage + "%";

          // 시간이 다 되면 데이터 다시 가져오기
          if (timeLeft <= 0) {
            clearInterval(timer);
            renderData();
            setupRefreshTimer(); // 타이머 재설정
          }
        }, 1000);

        // 새로고침 버튼 이벤트 핸들러
        document
          .getElementById("refreshButton")
          .addEventListener("click", () => {
            clearInterval(timer);
            renderData();
            setupRefreshTimer();
          });

        // 타이머 객체 반환 (필요시 정리를 위해)
        return timer;
      }

      // 페이지 로드 시 데이터 렌더링 및 타이머 설정
      document.addEventListener("DOMContentLoaded", () => {
        renderData();
        setupRefreshTimer();
      });
    </script>
  </body>
</html>
