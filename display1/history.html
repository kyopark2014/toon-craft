<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>4컷 만화 스타일 갤러리</title>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap");
      @import url("https://fonts.googleapis.com/css2?family=Comic+Neue:wght@700&display=swap");

      body {
        background-color: #f8f4e9;
        background-image: url("https://d2w79zoxq32d33.cloudfront.net/html/background.jpg");
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
        min-height: 100vh;
        margin: 0;
        font-family: "Noto Sans KR", sans-serif;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 0;
        overflow-x: hidden;
      }

      .comic-title {
        font-family: "Comic Neue", cursive;
        font-size: 2.5rem;
        color: #333;
        text-align: center;
        margin: 15px 0;
        background-color: #fff;
        padding: 10px 30px;
        border-radius: 50px;
        border: 3px solid #000;
        box-shadow: 5px 5px 0 #000;
        transform: rotate(-2deg);
      }

      .comic-container {
        max-width: 95vw;
        width: 95%;
        background-color: #fff;
        border: 5px solid #000;
        border-radius: 15px;
        padding: 15px;
        box-shadow: 10px 10px 0 #000;
        margin-bottom: 20px;
      }

      .comic-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        grid-template-rows: repeat(2, auto);
        gap: 30px;
        padding: 10px;
        max-width: 100%;
        margin: 0;
      }

      .comic-panel {
        position: relative;
        width: 100%;
        height: 0;
        padding-bottom: 100%;
        background-color: #fff;
        border: 5px solid #000;
        border-radius: 5px;
        overflow: hidden;
        box-shadow: inset 0 0 15px rgba(0, 0, 0, 0.2);
        transition: transform 0.3s ease;
      }

      .comic-panel:hover {
        transform: scale(1.02);
        z-index: 10;
      }

      .comic-panel img,
      .comic-panel video {
        position: absolute;
        width: 100%;
        height: 100%;
        object-fit: cover;
        top: 0;
        left: 0;
      }

      /* 패널 번호 스타일 제거 */

      .panel-caption {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        background-color: rgba(255, 255, 255, 0.8);
        padding: 8px;
        font-family: "Comic Neue", cursive;
        font-weight: bold;
        text-align: center;
        border-top: 3px solid #000;
      }

      /* 말풍선 스타일 */
      .speech-bubble {
        position: absolute;
        background-color: #fff;
        border: 3px solid #000;
        border-radius: 20px;
        padding: 8px 15px;
        font-family: "Comic Neue", cursive;
        font-weight: bold;
        font-size: 1.1rem;
        max-width: 70%;
        text-align: center;
        box-shadow: 3px 3px 0 #000;
        z-index: 5;
      }

      .speech-bubble::after {
        content: "";
        position: absolute;
        border: 15px solid transparent;
        border-top-color: #fff;
        border-bottom: 0;
        bottom: -12px;
        left: 50%;
        margin-left: -15px;
        z-index: 5;
      }

      .speech-bubble::before {
        content: "";
        position: absolute;
        border: 18px solid transparent;
        border-top-color: #000;
        border-bottom: 0;
        bottom: -18px;
        left: 50%;
        margin-left: -18px;
        z-index: 4;
      }

      .panel-1-bubble {
        top: 20px;
        left: 15px;
        background-color: #ffff99;
      }

      .panel-2-bubble {
        top: 20px;
        right: 15px;
        background-color: #ff9999;
      }

      .panel-3-bubble {
        top: 20px;
        left: 15px;
        background-color: #99ff99;
      }

      .panel-4-bubble {
        top: 20px;
        right: 15px;
        background-color: #9999ff;
      }

      /* 효과음 스타일 */
      .sound-effect {
        position: absolute;
        font-family: "Comic Neue", cursive;
        font-weight: bold;
        font-size: 2rem;
        color: #ff5252;
        text-shadow: 2px 2px 0 #000;
        z-index: 5;
        transform: rotate(-10deg);
      }

      .panel-1-effect {
        top: 65%;
        right: 20px;
      }

      .panel-2-effect {
        top: 60%;
        left: 20px;
      }

      .panel-3-effect {
        top: 65%;
        right: 25px;
      }

      .panel-4-effect {
        top: 60%;
        left: 25px;
      }

      .text-content {
        background-color: #fff;
        border: 5px solid #000;
        border-radius: 15px;
        padding: 20px;
        font-family: "Noto Sans KR", sans-serif;
        line-height: 1.6;
        max-width: 95vw;
        width: 95%;
        margin-top: 20px;
        margin-bottom: 20px;
        box-shadow: 10px 10px 0 #000;
        position: relative;
      }

      .text-content::before {
        content: "";
        position: absolute;
        width: 30px;
        height: 30px;
        background-color: #fff;
        border-left: 5px solid #000;
        border-top: 5px solid #000;
        top: -20px;
        left: 50%;
        transform: translateX(-50%) rotate(45deg);
      }

      .text-content h4 {
        margin: 0 0 10px 0;
        color: #333;
        font-size: 1.5rem;
        border-bottom: 3px dashed #ff5252;
        padding-bottom: 5px;
        display: inline-block;
      }

      .text-content ul {
        margin: 0;
        padding-left: 20px;
        list-style-type: none;
      }

      .text-content ul li {
        position: relative;
        padding-left: 25px;
        margin-bottom: 8px;
      }

      .text-content ul li::before {
        content: "✦";
        position: absolute;
        left: 0;
        color: #ff5252;
        font-weight: bold;
      }

      .emotion-highlight {
        display: inline-block;
        background-color: #ffff00;
        padding: 3px 8px;
        border-radius: 10px;
        font-weight: bold;
        transform: rotate(-2deg);
        margin: 0 2px;
        border: 2px solid #000;
        box-shadow: 2px 2px 0 #000;
      }

      .situation-box {
        background-color: #e6f7ff;
        border: 3px solid #000;
        border-radius: 10px;
        padding: 10px 15px;
        margin: 10px 0;
        box-shadow: 5px 5px 0 #000;
      }

      .text-content pre {
        background-color: #fffc9e;
        padding: 15px;
        border-radius: 10px;
        margin: 15px 0;
        border: 3px solid #000;
        font-family: "Noto Sans KR", sans-serif;
        white-space: pre-wrap;
      }

      .thought-bubble {
        position: absolute;
        width: 60px;
        height: 60px;
        background-color: #fff;
        border: 3px solid #000;
        border-radius: 50%;
        top: -70px;
        right: 30px;
        z-index: 5;
      }

      .thought-bubble::before,
      .thought-bubble::after {
        content: "";
        position: absolute;
        background-color: #fff;
        border: 3px solid #000;
        border-radius: 50%;
      }

      .thought-bubble::before {
        width: 30px;
        height: 30px;
        bottom: -15px;
        right: 10px;
      }

      .thought-bubble::after {
        width: 15px;
        height: 15px;
        bottom: -25px;
        right: 0;
      }

      .loading {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 200px;
        width: 100%;
      }

      .loading-spinner {
        border: 8px solid #f3f3f3;
        border-top: 8px solid #ff5252;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .error-message {
        background-color: #ffdddd;
        color: #ff0000;
        padding: 15px;
        border-radius: 10px;
        margin: 20px 0;
        border: 3px solid #ff0000;
        font-weight: bold;
        text-align: center;
      }
    </style>
  </head>
  <body>
    <h1 class="comic-title">오늘의 요리 이야기</h1>

    <div class="comic-container">
      <div id="comicGrid" class="comic-grid">
        <div class="loading">
          <div class="loading-spinner"></div>
        </div>
      </div>
    </div>

    <div id="textContent" class="text-content">
      <div class="thought-bubble"></div>
      <div class="loading">
        <div class="loading-spinner"></div>
      </div>
    </div>

    <script>
      // DynamoDB에서 데이터를 가져오는 함수 시뮬레이션
      async function fetchDataFromDynamoDB() {
        try {
          // 실제 환경에서는 여기에 AWS SDK를 사용하여 DynamoDB에서 데이터를 가져오는 코드가 들어갑니다
          // 지금은 주어진 예제 데이터를 사용
          return {
            id: "user1234",
            episode:
              "어느 날 동료들과 함께 커피를 마시던 중, 새로운 아이디어에 대해 열띤 토론을 벌였습니다. 그는 자신의 아이디어를 설명하며 열정적으로 손짓을 하였고, 결국 그의 아이디어가 채택되었습니다. :짠:",
            media_list: [
              "https://d3dybxg1g4fwkj.cloudfront.net/multi_shot_automated_2/120_Doenjang_Jjigae_1_ingredients_5_20250414_202423_20250506_114301/dygsdxd00vro/shot_0001.mp4",
              "https://d2w79zoxq32d33.cloudfront.net/familiar-15-menus2/120_Doenjang_Jjigae_2_preparation_3_20250414_202518.png",
              "https://d2w79zoxq32d33.cloudfront.net/familiar-15-menus2/120_Doenjang_Jjigae_3_cooking_3_20250414_202622.png",
              "https://d3dybxg1g4fwkj.cloudfront.net/multi_shot_automated_2/120_Doenjang_Jjigae_4_plating_1_20250414_202722_20250506_115124/sutvi1pozw4w/shot_0005.mp4",
            ],
            persona:
              "이 인물은 30대 후반의 남성으로 보입니다. 안경을 쓰고 있어 지적인 이미지를 가지고 있으며, 웃는 표정으로 보아 친근하고 쾌활한 성격을 가지고 있는 것으로 보입니다. 아마도 학문적인 분야에서 일하는 직업을 가지고 있을 것 같습니다.",
            questions: [
              {
                question:
                  "이번에 동료들과 함께 열띬로 토론한 아이디어에 대해 생각해 보았을 때, 당신이 가장 좋아하는 토론 주제는 무엇인가요?",
                answer: "과학 기술 관련 주제",
              },
              {
                question:
                  "동료들과 아이디어를 토론하며 열정적으로 손짓을 하던 모습을 보고, 당신은 어떤 활동을 통해 자신의 생각을 표현하는 것을 좋아하나요?",
                answer:
                  "예술적인 표현을 통해 자신의 생각을 전달하는 것, 예를 들어 그림이나 음악",
              },
              {
                question:
                  "이 인물이 취미 활동으로 가장 즐기는 것은 무엇인가요? 아래 중 하나를 선택해 주세요.",
                answer: "커피숍에서 다양한 음료를 시음하기",
              },
            ],
            recommend: `
#### 오늘의 당신은?
- **현재 감정**: 성취감, 열정, 기쁨
- **상황**: 동료들과의 토론에서 아이디어가 채택되어 성공적인 순간을 경험함
#### 추천 음식
\`\`\`txt
과학적 호기심과 예술적 감성이 공존하는 당신에게, 성취의 기쁨을 더욱 풍성하게 해줄 색감이 화려하고 다양한 맛의 조화가 돋보이는 한식 요리
\`\`\`
#### 추천 이유
오늘 당신은 마치 완벽한 커피 한 잔처럼 균형 잡힌 하루를 보내셨군요! 과학 기술에 대한 열정과 예술적 감성을 모두 갖춘 당신의 아이디어가 빛을 발한 특별한 날이니, 그 성취감을 더욱 풍성하게 해줄 음식이 필요합니다.
마치 다양한 커피를 음미하듯 여러 맛이 조화롭게 어우러진 한식이 어떨까요? 색감이 화려한 음식은 당신의 예술적 감성을 만족시키고, 다채로운 맛의 조합은 과학적 호기심을 자극할 거예요. 성공의 짜릿함을 입안 가득 느끼며, 오늘의 기쁨을 더욱 특별하게 기념해보세요. 당신의 빛나는 아이디어처럼, 오늘 저녁도 빛나길 바랍니다!
`,
            recommend_id: "120",
            result:
              "# 왕성식당의 된장찌개, 당신의 열정적인 토론 후에 딱 맞는 선택이네요! 🌟\n\n안녕하세요, 지적이면서도 친근한 매력을 가진 당신! 열정적인 토론 끝에 아이디어가 채택되었다니 정말 축하드려요! 👏 그 성취감을 더욱 특별하게 만들어줄 음식을 소개해드릴게요.",
          };
        } catch (error) {
          console.error("데이터를 가져오는 중 오류가 발생했습니다:", error);
          throw error;
        }
      }

      // 말풍선 텍스트 설정
      const speechBubbleTexts = [
        "재료 준비 완료!",
        "양념이 핵심이지!",
        "이렇게 끓여야 맛있어~",
        "완성! 맛있게 드세요!",
      ];

      // 효과음 텍스트 설정
      const soundEffectTexts = ["탁! 탁!", "와글와글!", "보글보글~", "짜잔!"];

      // 캡션 텍스트 설정
      const captionTexts = [
        "신선한 재료로 시작해요",
        "정성스럽게 준비합니다",
        "푹 끓여 깊은 맛을 냅니다",
        "완성된 요리를 즐겨보세요",
      ];

      // 데이터를 가져와 화면에 표시하는 함수
      async function renderData() {
        try {
          const data = await fetchDataFromDynamoDB();
          const comicGrid = document.getElementById("comicGrid");
          const textContent = document.getElementById("textContent");

          // 로딩 표시 제거
          comicGrid.innerHTML = "";

          // 에피소드 정보를 제목에 적용
          const episodeParts = data.episode.split(":짠:");
          document.querySelector(".comic-title").textContent = `${
            data.recommend_id
          } - ${episodeParts[0].substring(0, 20)}...`;

          // 미디어 패널 생성
          data.media_list.forEach((mediaUrl, index) => {
            const panel = document.createElement("div");
            panel.className = "comic-panel";

            // 미디어 타입에 따라 이미지 또는 비디오 태그 생성
            if (mediaUrl.endsWith(".mp4")) {
              panel.innerHTML = `
                <video controls loop autoplay muted>
                  <source src="${mediaUrl}" type="video/mp4">
                  브라우저가 비디오를 지원하지 않습니다.
                </video>
                <div class="speech-bubble panel-${index + 1}-bubble">${
                speechBubbleTexts[index]
              }</div>
                <div class="sound-effect panel-${index + 1}-effect">${
                soundEffectTexts[index]
              }</div>
                <div class="panel-caption">${captionTexts[index]}</div>
              `;
            } else {
              panel.innerHTML = `
                <img src="${mediaUrl}" alt="만화 컷 ${index + 1}">
                <div class="speech-bubble panel-${index + 1}-bubble">${
                speechBubbleTexts[index]
              }</div>
                <div class="sound-effect panel-${index + 1}-effect">${
                soundEffectTexts[index]
              }</div>
                <div class="panel-caption">${captionTexts[index]}</div>
              `;
            }

            comicGrid.appendChild(panel);
          });

          // 추천 정보 분석 및 표시
          const recommendData = parseRecommendation(data.recommend);

          // 텍스트 내용 표시
          textContent.innerHTML = `
            <div class="thought-bubble"></div>
            <h4>오늘의 당신은?</h4>
            <ul>
              <li><strong>현재 감정</strong>: ${formatEmotions(
                recommendData.emotions
              )}</li>
              <li>
                <strong>상황</strong>: 
                <div class="situation-box">
                  ${formatSituation(recommendData.situation, data.persona)}
                </div>
              </li>
            </ul>
            <h4>추천 음식</h4>
            <pre>${recommendData.food}</pre>
            <h4>추천 이유</h4>
            <p>${formatReason(recommendData.reason, data)}</p>
          `;
        } catch (error) {
          // 오류 처리
          const comicGrid = document.getElementById("comicGrid");
          const textContent = document.getElementById("textContent");

          comicGrid.innerHTML =
            '<div class="error-message">컷을 불러오는 중 오류가 발생했습니다.</div>';
          textContent.innerHTML =
            '<div class="error-message">콘텐츠를 불러오는 중 오류가 발생했습니다.</div>';

          console.error("렌더링 중 오류가 발생했습니다:", error);
        }
      }

      // 추천 정보 파싱
      function parseRecommendation(recommendText) {
        // 마크다운 내용을 파싱
        const emotionsMatch = recommendText.match(
          /\*\*현재 감정\*\*:\s*(.*?)(?=\n|-)/
        );
        const situationMatch = recommendText.match(
          /\*\*상황\*\*:\s*(.*?)(?=\n|\*\*)/
        );
        const foodMatch = recommendText.match(/```txt\n([\s\S]*?)```/);
        const reasonMatch = recommendText.match(/#### 추천 이유\n([\s\S]*?)$/);

        return {
          emotions: emotionsMatch
            ? emotionsMatch[1].trim()
            : "성취감, 열정, 기쁨",
          situation: situationMatch
            ? situationMatch[1].trim()
            : "동료들과의 토론에서 아이디어가 채택되어 성공적인 순간을 경험함",
          food: foodMatch
            ? foodMatch[1].trim()
            : "과학적 호기심과 예술적 감성이 공존하는 당신에게, 성취의 기쁨을 더욱 풍성하게 해줄 색감이 화려하고 다양한 맛의 조화가 돋보이는 한식 요리",
          reason: reasonMatch
            ? reasonMatch[1].trim()
            : "오늘 당신은 마치 완벽한 커피 한 잔처럼 균형 잡힌 하루를 보내셨군요!",
        };
      }

      // 감정 표시 형식 지정
      function formatEmotions(emotions) {
        return emotions
          .split(",")
          .map(
            (emotion) =>
              `<span class="emotion-highlight">${emotion.trim()}</span>`
          )
          .join(" ");
      }

      // 상황 표시 형식 지정
      function formatSituation(situation, persona) {
        let situationText = situation;

        // 페르소나 정보를 활용
        if (persona) {
          const personalityTraits = extractPersonalityTraits(persona);
          situationText += ` <span class="emotion-highlight">성공적인 순간</span>을 경험하셨군요! ${personalityTraits}`;
        }

        return situationText;
      }

      // 페르소나에서 성격 특성 추출
      function extractPersonalityTraits(persona) {
        // 간단하게 추출
        if (persona.includes("지적인"))
          return "당신의 지적인 통찰력이 빛난 순간입니다.";
        if (persona.includes("쾌활한"))
          return "당신의 쾌활한 에너지가 주변을 밝게 했습니다.";
        return "당신의 창의적인 생각이 인정받은 특별한 하루입니다.";
      }

      // 추천 이유 표시 형식 지정
      function formatReason(reason, data) {
        let formattedReason = reason;

        // 답변 정보를 활용하여 강조
        if (data.questions && data.questions.length > 0) {
          data.questions.forEach((q) => {
            if (q.answer && formattedReason.includes(q.answer)) {
              formattedReason = formattedReason.replace(
                new RegExp(q.answer, "g"),
                `<span class="emotion-highlight">${q.answer}</span>`
              );
            }
          });
        }

        // 중요 단어나 문구 강조
        const keyPhrases = [
          "성취감",
          "열정",
          "기쁨",
          "아이디어",
          "균형",
          "커피",
          "예술적 감성",
          "과학 기술",
        ];
        keyPhrases.forEach((phrase) => {
          if (formattedReason.includes(phrase)) {
            formattedReason = formattedReason.replace(
              new RegExp(phrase, "g"),
              `<span class="emotion-highlight">${phrase}</span>`
            );
          }
        });

        return formattedReason;
      }

      // 페이지 로드 시 데이터 렌더링
      window.addEventListener("DOMContentLoaded", renderData);
    </script>
  </body>
</html>
